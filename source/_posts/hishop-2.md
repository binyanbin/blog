---
title: Himall架构方案总结
date: 2016-6-5
desc: 分布式架构 微服务
---
这段时间一直做[Himall](http://www.hishop.com.cn/products/himall/)的架构优化，也一直思考什么样的架构设计更合适大型商城系统或者是大型业务系统。从早期的集中化架构到现在的分布式架构，中间经历的各种问题，现在做一个总结。
<!-- more -->
## 集中化架构
![图](/img/hishop-7.png)
Himall早期功能比较少，而且业务相对简单。经过一段时间的开发，一个简单的应用诞生了。同时，集中式设计毫无争议的成为了团队的选择。但是，随着几次迭代开发之后，功能越来越多，业务越来越复杂，这种架构的缺点也渐渐地浮出了水面：
1. 系统的可维护性受到影响，尤其是那些大型应用
多人开发的一个复杂的应用系统，团队人数越多,开发人员必然层次不一，规范难统一，系统模块之间的耦合非常重,模块之间太多相互依赖，非常容易出问题。
2. 团队开发效率低，协调工作非常多
任何改动都会牵涉到多个业务模块,不可能所有开发人员能熟习所有模块，需要与其它业务模块开发人员沟通协调。
3. 负载均衡不能充分发挥作用
集中化架构下的应用即使你做负载均衡，服务器的性能会被所有功能平摊。不能实现服务器性能最大化，也不合适针对特定业务进行特别优化。
最终，曾经轻量简洁的应用将会变成一代又一代开发者的噩梦。

## 分布式架构
Himall必须寻找到一种方式，将轻量并且质量较好的那部分模块保留下来。也就是找到一个可持续发展的架构，并且在许多次功能迭代开发之后依旧能够让开发人员保持高效开发的开发方式。
 
### 纵向分解
![图](/img/hishop-8.png)
这是一个非常自然而通用的方法，把所有的功能集中到单一的应用中，不如将应用分解成了多个垂直的小模块，它们相互独立，互不影响,独立部署,通过REST请求来传递信息。

在模块之间共享代码是严令禁止的。当然，在特殊的情况下，如果我们需要分享代码，我们会建公共模块来解决该问题。依就以REST请求来访问代码。如日志功能，配置功能等

这些模块同样不能共享一个数据库架构，因为这样做会导致模块间的紧密耦合：数据结构的改变会使得一个模块不能够被独立的部署。对于共享数据部分，我们也建立一个公共数据库来解决这个问题，定期或不定期把数据同步到公共数据库中，汇总数据。这个同步工作由Daemon去完成。

但是一个垂直模块仍旧可能成为一个相对大型的集中化应用。
就拿订单来说，订单不仅包括了商品信息，库存验证，会员的积分使用或等及规则，还有商家的各种促销信息，才能算出订单价格，这样订单才可以支付。一个订单模块做下来依就是一个相对大型的集中化应用。因此我们需要继续对垂直模块进行拆分。

### 微服务
![图](/img/hishop-9.jpg)
通过分布式架构继续将模块分解成多个模块。
在这种情况下，应用不仅仅被垂直分解，同时还会被水平分解。这种架构中，请求到达应用后，对请求的处理会被分布于多个微服务中，然后每一微服务产生的结果汇总一个响应，发送回请求者。
每一个微服务，仅仅集中于一个业务模块中的几个功能,从而达到高内聚低耦合的目的，并且它结构清晰，一个开发者能够很轻松的掌握它。

一个模块由一个或多个微服务组成,模块之间的调用全由微服务接口完成，每个微服务自带数据存储,可以独立部署。模块可折，微服务可合，这种架构灵活性非常高。

#### 微服务负载均衡
由于微服务粒度划分较细，使用负载均衡更能按需扩展那些性能较差的微服务，发挥服务器的最大性能价值。

![图](/img/hishop-10.jpg)

在负载均衡中，不同实例的服务通常会分时使用同一个数据库，数据库因此成为了系统的瓶颈，这时我们采用性能更高的nosql数据库，如mongodb。不同微服务使用不同数据库并不会对系造成影响。

#### 优点
* 微服务非常小，微服务不需要重量级框架和过多的设计，代码相对简单。
* 他们能够被独立的部署。因此持续交付或者持续部署变得非常的简单。
* 开发者能够为每一个服务选择最适合的开发语言和数据库。不用担心对项目产生影响。
* 每个微服务可以独立测试，易于找出性能瓶颈。

#### 需要解决的问题
* 因为微服务数据较大，布署难度加大，需要建立一套更方便的部署机制。
* 同样需要建立统一的日志管理模块，方便找查问题。
* 同样需要统一配置信息管理.
* 公共数据的读写问题，如公共缓存，公共数据库。建立一套有效且高性的方案，来解决读写冲突。

虽然这些只是这段时间的经验总结，Himall也未完成达到我们所期望的状态，但是我们会继续朝这个访问努力。经过1-2年的迭代之后，我们的架构会更加成熟，经验变得更加丰富。

